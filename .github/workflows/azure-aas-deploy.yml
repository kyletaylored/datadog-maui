name: Build and deploy ASP.NET Framework app to Azure Web App - datadog-maui-framework-api

on:
  push:
    branches:
      - main
    paths:
      - 'ApiFramework/**'
      - '.github/workflows/azure-aas-deploy.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'datadog-maui-framework-api'
  SOLUTION_PATH: 'ApiFramework'
  SOLUTION_FILE: 'DatadogMauiApi.Framework.sln'
  PROJECT_FILE: 'DatadogMauiApi.Framework.csproj'
  PUBLISHED_DIR: '${{ github.workspace }}\\published'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Create .env file for build
        run: |
          echo "DD_RUM_WEB_CLIENT_TOKEN=${{ secrets.DD_RUM_WEB_CLIENT_TOKEN }}" > .env
          echo "DD_RUM_WEB_APPLICATION_ID=${{ secrets.DD_RUM_WEB_APPLICATION_ID }}" >> .env
        shell: bash

      - name: Validate NuGet config & restore packages (packages.config -> solution packages folder)
        working-directory: ./${{ env.SOLUTION_PATH }}
        shell: pwsh
        run: |
          # If a repository nuget.config exists, print it and pass it explicitly to nuget restore.
          if (Test-Path nuget.config) {
            Write-Host "==== Found nuget.config in repository: ===="
            Get-Content nuget.config
            $cfgArg = "-ConfigFile `"$PWD\nuget.config`""
          } else {
            Write-Host "==== No nuget.config in repository. Using default sources. ===="
            $cfgArg = ""
          }

          Write-Host "==== nuget.exe sources list (what nuget will use) ===="
          nuget.exe sources list

          # Clean local packages folder (idempotent)
          if (Test-Path packages) { Remove-Item -Recurse -Force packages }

          # Restore into local solution packages dir so classic HintPaths resolve
          if ($cfgArg -ne "") {
            nuget.exe restore ${{ env.SOLUTION_FILE }} -Verbosity detailed -PackagesDirectory "$(pwd)/packages" $cfgArg
          } else {
            nuget.exe restore ${{ env.SOLUTION_FILE }} -Verbosity detailed -PackagesDirectory "$(pwd)/packages"
          }

      - name: Sanity-check restored packages (Datadog.Trace DLL exists)
        working-directory: ./${{ env.SOLUTION_PATH }}
        shell: pwsh
        run: |
          Write-Host "Listing packages folder top-level entries:"
          if (!(Test-Path packages)) { Write-Host "packages folder missing - restore failed"; exit 1 }
          Get-ChildItem packages -Directory | Select-Object -First 80 | ForEach-Object { Write-Host $_.Name }

          # Verify Datadog.Trace.Manual.dll exists (used for compilation with auto-instrumentation)
          $ddDll = "packages\Datadog.Trace.3.35.0\lib\net461\Datadog.Trace.Manual.dll"

          if (!(Test-Path $ddDll)) {
            Write-Host "❌ Datadog.Trace.Manual.dll not found at: $ddDll"
            Write-Host "`nSearching for any .dll files in Datadog.Trace package:"
            Get-ChildItem "packages\Datadog.Trace.3.35.0" -Recurse -Filter "*.dll" -ErrorAction SilentlyContinue | ForEach-Object {
              Write-Host "  Found: $($_.Name) at $($_.DirectoryName)"
            }
            exit 1
          }

          Write-Host "✅ Found Datadog.Trace.Manual.dll at: $ddDll"

      - name: Build solution (Rebuild, create binlog)
        working-directory: ./${{ env.SOLUTION_PATH }}
        run: msbuild ${{ env.SOLUTION_FILE }} /m /t:Rebuild /p:Configuration=Release /p:Platform="Any CPU" /bl:"${{ github.workspace }}\msbuild.binlog"

      - name: Publish web project to folder
        working-directory: ./${{ env.SOLUTION_PATH }}
        run: >
          msbuild ${{ env.PROJECT_FILE }}
          /m
          /t:Build
          /p:Configuration=Release
          /p:Platform="Any CPU"
          /p:DeployOnBuild=true
          /p:WebPublishMethod=FileSystem
          /p:PublishUrl="${{ env.PUBLISHED_DIR }}"
          /p:DeleteExistingFiles=true

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: ASP-app
          path: ${{ github.workspace }}\published\**

      - name: Upload MSBuild binlog (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: msbuild-binlog
          path: ${{ github.workspace }}\msbuild.binlog

  deploy:
    runs-on: windows-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: ASP-app
          path: ./deployment

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_DAA39B26D38945719F59C89319B7F8AC }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_0D08AF753C1F4E8D9FF30BA4FA1065FA }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_81E4314D7F5740998781B038576ABF04 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'
          package: ./deployment

      - name: Health Check
        run: |
          echo "Waiting 30 seconds for deployment to complete..."
          Start-Sleep -Seconds 30
          try {
            $response = Invoke-RestMethod -Uri "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health" -TimeoutSec 10
            if ($response.status -eq "healthy") {
              Write-Host "✅ Health check passed"
              Write-Host "Response: $($response | ConvertTo-Json)"
            } else {
              Write-Host "⚠️ Health check returned unexpected status"
              Write-Host "Response: $($response | ConvertTo-Json)"
            }
          } catch {
            Write-Host "⚠️ Health check failed or timed out"
            Write-Host "Error: $($_.Exception.Message)"
            Write-Host "This may be normal if the app is still starting up"
          }
        shell: pwsh
