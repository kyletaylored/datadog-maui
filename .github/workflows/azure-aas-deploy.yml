name: Deploy .NET Framework to Azure Web App (code)

on:
  push:
    branches:
      - main
    paths:
      - 'ApiFramework/**'
      - '.github/workflows/azure-aas-deploy.yml'
  workflow_dispatch:

env:
  AZURE_WEBAPP_NAME: 'datadog-maui-api-framework'
  RUM_SERVICE: 'datadog-maui-web-framework'
  SOLUTION_PATH: 'ApiFramework'
  SOLUTION_FILE: 'DatadogMauiApi.Framework.sln'
  PROJECT_FILE: 'DatadogMauiApi.Framework.csproj'
  PUBLISHED_DIR: '${{ github.workspace }}\published'

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Create .env file for build
        run: |
          echo "DD_RUM_WEB_CLIENT_TOKEN=${{ secrets.DD_RUM_WEB_CLIENT_TOKEN }}" > .env
          echo "DD_RUM_WEB_APPLICATION_ID=${{ secrets.DD_RUM_WEB_APPLICATION_ID }}" >> .env
          echo "DD_RUM_WEB_SERVICE=${{ env.RUM_SERVICE }}" >> .env
          echo "DD_SITE=${{ secrets.DD_SITE }}" >> .env
          echo "DD_ENV=${{ secrets.DD_ENV }}" >> .env
          echo "DD_VERSION=${{ github.sha }}" >> .env
        shell: bash

      - name: Validate NuGet config & restore packages (packages.config -> solution packages folder)
        working-directory: ./${{ env.SOLUTION_PATH }}
        shell: pwsh
        run: |
          # If a repository nuget.config exists, print it and pass it explicitly to nuget restore.
          if (Test-Path nuget.config) {
            Write-Host "==== Found nuget.config in repository: ===="
            Get-Content nuget.config
            $cfgArg = "-ConfigFile `"$PWD\nuget.config`""
          } else {
            Write-Host "==== No nuget.config in repository. Using default sources. ===="
            $cfgArg = ""
          }

          Write-Host "==== nuget.exe sources list (what nuget will use) ===="
          nuget.exe sources list

          # Clean local packages folder (idempotent)
          if (Test-Path packages) { Remove-Item -Recurse -Force packages }

          # Restore into local solution packages dir so classic HintPaths resolve
          if ($cfgArg -ne "") {
            nuget.exe restore ${{ env.SOLUTION_FILE }} -Verbosity detailed -PackagesDirectory "$(pwd)/packages" $cfgArg
          } else {
            nuget.exe restore ${{ env.SOLUTION_FILE }} -Verbosity detailed -PackagesDirectory "$(pwd)/packages"
          }

      - name: Verify packages restored
        working-directory: ./${{ env.SOLUTION_PATH }}
        shell: pwsh
        run: |
          Write-Host "Listing restored packages:"
          if (!(Test-Path packages)) { Write-Host "❌ packages folder missing"; exit 1 }

          $packageCount = (Get-ChildItem packages -Directory).Count
          Write-Host "✅ Found $packageCount packages:"
          Get-ChildItem packages -Directory | ForEach-Object { Write-Host "  - $($_.Name)" }

          # Find Datadog.Trace package (any version)
          $ddPackage = Get-ChildItem packages -Directory -Filter "Datadog.Trace.*" | Select-Object -First 1
          if ($ddPackage) {
            Write-Host "`n✅ Found Datadog.Trace package: $($ddPackage.Name)"

            # Look for Datadog.Trace.Manual.dll in lib\net461
            $ddDll = Get-ChildItem "$($ddPackage.FullName)\lib\net461" -Filter "Datadog.Trace.Manual.dll" -ErrorAction SilentlyContinue
            if ($ddDll) {
              Write-Host "✅ Datadog.Trace.Manual.dll found (provides compile-time API)"
              Write-Host "   Runtime auto-instrumentation will be provided by Azure Datadog extension"
            } else {
              Write-Host "⚠️  Datadog.Trace.Manual.dll not found in expected location, but package exists"
            }
          } else {
            Write-Host "`n⚠️  Datadog.Trace package not found (may not be required)"
          }

      - name: Build solution (Rebuild, create binlog)
        working-directory: ./${{ env.SOLUTION_PATH }}
        run: msbuild ${{ env.SOLUTION_FILE }} /m /t:Rebuild /p:Configuration=Release /p:Platform="Any CPU" /bl:"${{ github.workspace }}\msbuild.binlog"

      - name: Publish web project to folder
        working-directory: ./${{ env.SOLUTION_PATH }}
        run: >
          msbuild ${{ env.PROJECT_FILE }}
          /t:WebPublish
          /p:Configuration=Release
          /p:Platform=AnyCPU
          /p:WebPublishMethod=FileSystem
          /p:publishUrl="${{ env.PUBLISHED_DIR }}"
          /p:DeleteExistingFiles=true
          /v:detailed
          /fl
          /flp:logfile="${{ github.workspace }}\publish.log"

      - name: Search for published files (diagnostic)
        shell: pwsh
        run: |
          Write-Host "=== Searching for Web.config files (indicates published app) ==="
          Get-ChildItem "${{ github.workspace }}" -Filter "Web.config" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found Web.config at: $($_.DirectoryName)"
          }

          Write-Host "`n=== Searching for bin directories (compiled output) ==="
          Get-ChildItem "${{ github.workspace }}" -Directory -Filter "bin" -Recurse -ErrorAction SilentlyContinue |
            Where-Object { $_.FullName -notlike "*\packages\*" } |
            ForEach-Object {
              Write-Host "Found bin at: $($_.FullName)"
              Write-Host "  Contents: $(((Get-ChildItem $_.FullName -File).Name -join ', ').Substring(0, [Math]::Min(200, ((Get-ChildItem $_.FullName -File).Name -join ', ').Length)))"
            }

          Write-Host "`n=== Checking expected publish directory ==="
          if (Test-Path "${{ env.PUBLISHED_DIR }}") {
            Write-Host "✅ Published directory exists at: ${{ env.PUBLISHED_DIR }}"
            $fileCount = (Get-ChildItem "${{ env.PUBLISHED_DIR }}" -Recurse -File).Count
            Write-Host "  Total files: $fileCount"
            Write-Host "  First 10 files:"
            Get-ChildItem "${{ env.PUBLISHED_DIR }}" -Recurse -File | Select-Object -First 10 | ForEach-Object {
              Write-Host "    $($_.FullName)"
            }
          } else {
            Write-Host "❌ Published directory NOT found at: ${{ env.PUBLISHED_DIR }}"
          }

          Write-Host "`n=== Searching for any 'published' directories ==="
          Get-ChildItem "${{ github.workspace }}" -Directory -Filter "*publish*" -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "Found: $($_.FullName)"
          }

      - name: Check if publish succeeded
        id: check-publish
        shell: pwsh
        run: |
          if (Test-Path "${{ env.PUBLISHED_DIR }}") {
            $fileCount = (Get-ChildItem "${{ env.PUBLISHED_DIR }}" -Recurse -File).Count
            if ($fileCount -gt 0) {
              Write-Host "✅ Found $fileCount files in publish directory"
              echo "has_files=true" >> $env:GITHUB_OUTPUT
            } else {
              Write-Host "❌ Publish directory exists but is empty"
              echo "has_files=false" >> $env:GITHUB_OUTPUT
              exit 1
            }
          } else {
            Write-Host "❌ Publish directory does not exist"
            echo "has_files=false" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: Upload artifact for deployment job
        if: steps.check-publish.outputs.has_files == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: ASP-app
          path: ${{ env.PUBLISHED_DIR }}\**

  deploy:
    runs-on: windows-latest
    needs: build
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v7
        with:
          name: ASP-app
          path: ./deployment

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Configure Datadog version
        shell: pwsh
        run: |
          az webapp config appsettings set \
            --resource-group ese-tola \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --settings DD_VERSION="${{ github.sha }}"
          Write-Host "✅ Set DD_VERSION to commit SHA: ${{ github.sha }}"

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          slot-name: 'Production'
          package: ./deployment

      - name: Health Check
        run: |
          echo "Waiting 30 seconds for deployment to complete..."
          Start-Sleep -Seconds 30
          try {
            $response = Invoke-RestMethod -Uri "https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net/health" -TimeoutSec 10
            if ($response.status -eq "healthy") {
              Write-Host "✅ Health check passed"
              Write-Host "Response: $($response | ConvertTo-Json)"
            } else {
              Write-Host "⚠️ Health check returned unexpected status"
              Write-Host "Response: $($response | ConvertTo-Json)"
            }
          } catch {
            Write-Host "⚠️ Health check failed or timed out"
            Write-Host "Error: $($_.Exception.Message)"
            Write-Host "This may be normal if the app is still starting up"
          }
        shell: pwsh
